<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Arduino Port Manager</title>

<style>
:root{
  --panel:#0d0d0d;--panel-alt:#141414;--panel-elevated:#1a1a1a;
  --border:#252525;--border-subtle:#1f1f1f;
  --text:#f0f0f0;--text-secondary:#b0b0b0;--muted:#707070;
  --accent:#22c55e;--accent-dim:rgba(34,197,94,0.15);
  --danger:#ef4444;--danger-dim:rgba(239,68,68,0.15);
  --info:#3b82f6;--info-dim:rgba(59,130,246,0.15);
  --warning:#f59e0b;--warning-dim:rgba(245,158,11,0.15);
}

body[data-theme="light"]{
  --panel:#f8f9fa;--panel-alt:#ffffff;--panel-elevated:#ffffff;
  --border:#e5e7eb;--border-subtle:#f0f0f0;
  --text:#111827;--text-secondary:#4b5563;--muted:#9ca3af;
  --accent:#059669;--accent-dim:rgba(5,150,105,0.1);
  --danger:#dc2626;--danger-dim:rgba(220,38,38,0.1);
  --info:#2563eb;--info-dim:rgba(37,99,235,0.1);
  --warning:#d97706;--warning-dim:rgba(217,119,6,0.1);
  background:linear-gradient(135deg,#f5f7fa 0%,#e4e8ed 100%);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  padding:20px 24px;
  background:#080808;
  color:var(--text);
  font-family:"Inter",-apple-system,"Segoe UI",sans-serif;
  display:flex;flex-direction:column;min-height:100vh;
  line-height:1.5;
}

/* Header */
header{
  display:flex;justify-content:space-between;align-items:flex-start;
  margin-bottom:20px;gap:16px;flex-wrap:wrap;
}
.header-left h1{
  font-size:22px;font-weight:700;color:var(--accent);
  letter-spacing:-0.5px;margin-bottom:2px;
}
.header-left .subtitle{font-size:12px;color:var(--muted);}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

/* Status pills */
.pill{
  display:inline-flex;align-items:center;gap:5px;
  padding:5px 10px;border-radius:6px;font-size:11px;font-weight:500;
  background:var(--panel-elevated);border:1px solid var(--border);
}
.pill.ok{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}
.pill.bad{background:var(--danger-dim);border-color:var(--danger);color:var(--danger);}
.pill.warn{background:var(--warning-dim);border-color:var(--warning);color:var(--warning);}
.pill .dot{width:6px;height:6px;border-radius:50%;background:currentColor;}

/* Toolbar */
.toolbar{
  display:flex;gap:8px;padding:12px 16px;margin-bottom:16px;
  background:var(--panel);border:1px solid var(--border);border-radius:10px;
  align-items:center;flex-wrap:wrap;
}
.toolbar-section{display:flex;align-items:center;gap:6px;}
.toolbar-divider{width:1px;height:24px;background:var(--border);margin:0 8px;}
.toolbar label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
.toolbar select,.toolbar input[type="text"]{
  background:var(--panel-alt);color:var(--text);
  border:1px solid var(--border);border-radius:6px;
  padding:6px 10px;font-size:12px;min-width:140px;
}
.toolbar button{
  background:var(--panel-elevated);color:var(--text);
  border:1px solid var(--border);border-radius:6px;
  padding:6px 12px;font-size:11px;font-weight:500;cursor:pointer;
  transition:all .15s ease;
}
.toolbar button:hover{background:var(--border);border-color:var(--text-secondary);}
.toolbar button.primary{background:var(--accent);color:#000;border-color:var(--accent);}
.toolbar button.primary:hover{filter:brightness(1.1);}

/* Search */
.search-box{
  position:relative;margin-bottom:16px;
}
.search-box input{
  width:100%;padding:10px 14px 10px 36px;border-radius:8px;
  border:1px solid var(--border);background:var(--panel);
  color:var(--text);font-size:13px;
}
.search-box::before{
  content:"⌕";position:absolute;left:12px;top:50%;
  transform:translateY(-50%);color:var(--muted);font-size:14px;
}

/* Grid */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:12px;
}

/* Card */
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  transition:border-color .2s ease,box-shadow .2s ease;
}
.card:hover{border-color:var(--border-subtle);box-shadow:0 4px 20px rgba(0,0,0,0.3);}

.card-top{
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:14px 16px 10px;border-bottom:1px solid var(--border-subtle);
}
.card-title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:2px;}
.card-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:4px;}
.card-tag{
  font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500;
  background:var(--panel-elevated);color:var(--text-secondary);
  border:1px solid var(--border-subtle);
}
.card-tag.id{background:var(--accent-dim);color:var(--accent);border-color:var(--accent);}
.card-tag.port{font-family:"JetBrains Mono",monospace;background:var(--info-dim);color:var(--info);border-color:var(--info);}
.card-tag.role{background:var(--panel-elevated);color:var(--text-secondary);}

.card-status{
  display:flex;flex-direction:column;align-items:flex-end;gap:4px;
}
.status-badge{
  font-size:9px;padding:3px 8px;border-radius:4px;font-weight:600;
  text-transform:uppercase;letter-spacing:0.3px;
}
.status-badge.connected{background:var(--accent-dim);color:var(--accent);}
.status-badge.missing{background:var(--danger-dim);color:var(--danger);}
.port-status{font-size:9px;color:var(--muted);}
.port-status.whitelisted{color:var(--accent);}
.port-status.blacklisted{color:var(--danger);}

.card-body{padding:12px 16px;}

.hw-info{
  display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;
  font-size:11px;color:var(--text-secondary);
  padding:8px 10px;background:var(--panel-alt);border-radius:6px;
  margin-bottom:10px;
}
.hw-info span{display:flex;align-items:center;gap:4px;}
.hw-info .label{color:var(--muted);font-size:10px;}

.simhub-box{
  padding:10px 12px;border-radius:8px;margin-bottom:10px;
  border:1px solid var(--accent);background:var(--accent-dim);
}
.simhub-box.error{border-color:var(--danger);background:var(--danger-dim);}
.simhub-header{
  display:flex;align-items:center;gap:6px;margin-bottom:6px;
  font-size:10px;font-weight:600;text-transform:uppercase;
  letter-spacing:0.5px;color:var(--accent);
}
.simhub-box.error .simhub-header{color:var(--danger);}
.simhub-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:11px;
}
.simhub-grid span{color:var(--text-secondary);}
.simhub-grid strong{color:var(--text);font-weight:500;}
.simhub-uid{font-size:9px;color:var(--muted);margin-top:6px;word-break:break-all;}

.connection-time{font-size:10px;color:var(--muted);margin-bottom:8px;}

/* Actions */
.card-actions{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;background:var(--panel-alt);
  border-top:1px solid var(--border-subtle);
}
.card-actions .left{font-size:10px;color:var(--muted);}
.card-actions .right{display:flex;gap:6px;}

button{
  border:none;padding:6px 12px;border-radius:5px;
  font-weight:500;cursor:pointer;font-size:11px;
  transition:all .15s ease;
}
.btn-install{background:var(--info);color:white;}
.btn-install:hover{filter:brightness(1.15);}
.btn-identify{background:var(--panel-elevated);color:var(--text);border:1px solid var(--border);}
.btn-identify:hover{background:var(--border);}
.btn-identify.active{background:var(--danger);color:white;border-color:var(--danger);animation:pulse .6s infinite;}
.btn-test{background:var(--panel-elevated);color:var(--text);border:1px solid var(--border);}
.btn-test:hover{background:var(--border);}
.btn-edit{background:var(--accent);color:#000;font-weight:600;}
.btn-edit:hover{filter:brightness(1.1);}

/* Footer */
.main{flex:1 0 auto;}
.footer{
  margin-top:24px;padding:16px 0;
  border-top:1px solid var(--border);
  font-size:11px;color:var(--muted);
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:12px;
}
.footer a{color:var(--accent);text-decoration:none;}
.footer a:hover{text-decoration:underline;}
.footer-btns{display:flex;gap:4px;}
.footer-btn{
  background:var(--panel-elevated);color:var(--text-secondary);
  border:1px solid var(--border);border-radius:5px;
  padding:4px 10px;font-size:10px;cursor:pointer;
}
.footer-btn:hover{background:var(--border);color:var(--text);}

/* Tooltip */
.tooltip{position:relative;display:inline-block;}
.tooltip-bubble{
  position:absolute;bottom:130%;right:0;
  background:var(--panel-elevated);color:var(--text);
  padding:8px 10px;border-radius:6px;border:1px solid var(--border);
  white-space:nowrap;font-size:10px;
  opacity:0;pointer-events:none;
  transform:translateY(4px);transition:all .15s ease;z-index:200;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.tooltip:hover .tooltip-bubble{opacity:1;transform:translateY(0);}

@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

/* Modal */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:none;align-items:center;justify-content:center;z-index:100;
  backdrop-filter:blur(4px);
}
.modal.open{display:flex}
.modal-box{
  background:var(--panel);padding:24px;border-radius:12px;
  border:1px solid var(--border);width:380px;
  max-height:85vh;overflow-y:auto;
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}
.modal-box h2{font-size:18px;font-weight:600;color:var(--accent);margin-bottom:16px;}
.modal-box input,.modal-box select{
  width:100%;margin-bottom:8px;padding:10px 12px;border-radius:6px;
  background:var(--panel-alt);color:var(--text);border:1px solid var(--border);
  font-size:13px;
}
.modal-box input:focus,.modal-box select:focus{outline:none;border-color:var(--accent);}
.field-help{font-size:10px;color:var(--muted);margin:-4px 0 12px;line-height:1.4;}

/* Active Profiles Banner */
.profiles-banner{
  display:flex;gap:16px;padding:10px 16px;margin-bottom:16px;
  background:var(--panel);border:1px solid var(--border);border-radius:10px;
  font-size:11px;
}
.profile-item{display:flex;align-items:center;gap:6px;}
.profile-item .label{color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:0.5px;}
.profile-item .value{color:var(--text);font-weight:500;}
.profile-item .brightness{color:var(--warning);font-size:10px;}
</style>
</head>

<body>

<div class="main">
<header>
  <div class="header-left">
    <h1>Arduino Port Manager</h1>
    <div class="subtitle">SimHub Device Registry & Identifier</div>
  </div>
  <div class="header-right">
    <div class="pill ok"><span class="dot"></span>{{ stats.connected }} Online</div>
    {% if stats.missing > 0 %}
    <div class="pill bad"><span class="dot"></span>{{ stats.missing }} Offline</div>
    {% endif %}
    <div class="pill {{ 'ok' if stats.simhub_running else 'bad' }}" title="SimHub process status">
      <span class="dot"></span>{{ 'SimHub' if stats.simhub_running else 'No SimHub' }}
    </div>
    <div class="pill {{ 'ok' if stats.plugin_installed else 'bad' }}" title="ArduinoIdentifyPlugin.dll">
      <span class="dot"></span>{{ 'Plugin OK' if stats.plugin_installed else 'No Plugin' }}
    </div>
  </div>
</header>

<div class="toolbar">
  <div class="toolbar-section">
    <label>Profile</label>
    <form method="post" action="/profile/load" style="display:flex;gap:6px;align-items:center;">
      <select name="name">
        <option value="">Select…</option>
        {% for p in profiles %}
          <option value="{{ p }}">{{ p }}</option>
        {% endfor %}
      </select>
      <button type="submit">Load</button>
    </form>
  </div>
  <div class="toolbar-section">
    <form method="post" action="/profile/save" style="display:flex;gap:6px;align-items:center;">
      <input type="text" name="name" placeholder="Profile name…" style="width:130px;">
      <button type="submit">Save</button>
    </form>
  </div>
  <div class="toolbar-divider"></div>
  <button class="primary" onclick="bulkInstall()" title="Assign IDs to all uninstalled devices">Bulk Install</button>
</div>

{% if stats.active_profiles %}
<div class="profiles-banner">
  {% if stats.active_profiles.rgb_leds %}
  <div class="profile-item">
    <span class="label">RGB LEDs</span>
    <span class="value">{{ stats.active_profiles.rgb_leds.name }}</span>
    <span class="brightness">{{ stats.active_profiles.rgb_leds.brightness|int }}%</span>
  </div>
  {% endif %}
  {% if stats.active_profiles.rgb_matrix %}
  <div class="profile-item">
    <span class="label">Matrix</span>
    <span class="value">{{ stats.active_profiles.rgb_matrix.name }}</span>
    <span class="brightness">{{ stats.active_profiles.rgb_matrix.brightness|int }}%</span>
  </div>
  {% endif %}
</div>
{% endif %}

<div class="search-box">
  <input placeholder="Filter devices by name, port, role…" oninput="filterCards(this.value)">
</div>

<div class="grid">
{% for d in devices %}
  <div class="card" data-search="{{ d.name }} {{ d.port }} {{ d.role }} {{ d.identify_id }} {{ d.channel }} {{ d.group }}">

    <div class="card-top">
      <div>
        <div class="card-title">{{ d.name if d.name else 'Unnamed Arduino' }}</div>
        <div class="card-meta">
          <span class="card-tag port">{{ d.port }}</span>
          {% if d.identify_id %}
          <span class="card-tag id">ID {{ d.identify_id }}</span>
          {% endif %}
          {% if d.role and d.role != 'Unassigned' %}
          <span class="card-tag role">{{ d.role }}</span>
          {% endif %}
          {% if d.channel and d.channel != 0 %}
          <span class="card-tag">CH{{ d.channel }}</span>
          {% endif %}
        </div>
      </div>
      <div class="card-status">
        <span class="status-badge {{ 'connected' if d.status=='connected' else 'missing' }}">
          {{ d.status }}
        </span>
        {% if d.port_status and d.port_status != 'unlisted' %}
        <span class="port-status {{ d.port_status }}">
          {{ '✓ Whitelisted' if d.port_status == 'whitelisted' else '✗ Blacklisted' }}
        </span>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      {% if d.description or d.manufacturer or d.vid or d.pid %}
      <div class="hw-info">
        {% if d.description %}
        <span><span class="label">Device</span> {{ d.description }}</span>
        {% endif %}
        {% if d.manufacturer %}
        <span><span class="label">Maker</span> {{ d.manufacturer }}</span>
        {% endif %}
        {% if d.vid or d.pid %}
        <span><span class="label">USB</span> {{ d.vid or '----' }}:{{ d.pid or '----' }}</span>
        {% endif %}
        {% if d.connected_for %}
        <span><span class="label">Uptime</span> {{ d.connected_for }}</span>
        {% endif %}
      </div>
      {% endif %}

      {% if d.simhub %}
      <div class="simhub-box">
        <div class="simhub-header">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
          SimHub Linked
        </div>
        <div class="simhub-grid">
          {% if d.simhub.simhub_name %}
          <span>Name: <strong>{{ d.simhub.simhub_name }}</strong></span>
          {% endif %}
          {% if d.simhub.rgb_leds %}
          <span>RGB LEDs: <strong>{{ d.simhub.rgb_leds }}</strong></span>
          {% endif %}
          {% if d.simhub.display_modules %}
          <span>Displays: <strong>{{ d.simhub.display_modules }}</strong></span>
          {% endif %}
          {% if d.simhub.motors %}
          <span>Motors: <strong>{{ d.simhub.motors }}</strong></span>
          {% endif %}
          {% if d.simhub.read_buttons %}
          <span>Buttons: <strong>Yes</strong></span>
          {% endif %}
          <span>Status: <strong style="color:{{ 'var(--danger)' if d.simhub.disabled else 'var(--accent)' }}">{{ 'Disabled' if d.simhub.disabled else 'Active' }}</strong></span>
        </div>
        <div class="simhub-uid">{{ d.simhub_uid }}</div>
      </div>
      {% elif d.simhub_uid %}
      <div class="simhub-box error">
        <div class="simhub-header">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          SimHub UID Not Found
        </div>
        <div style="font-size:10px;">Device configured but not in SimHub config</div>
      </div>
      {% endif %}

      {% if not d.simhub and d.connected_for and not (d.description or d.manufacturer or d.vid) %}
      <div class="connection-time">Connected for {{ d.connected_for }}</div>
      {% endif %}
    </div>

    <div class="card-actions">
      <div class="left">
        {% if d.group %}{{ d.group }}{% else %}No group{% endif %}
      </div>
      <div class="right">
        {% if not d.installed %}
        <button class="btn-install" title="Assign an Identify ID" onclick="installDevice('{{ d.key }}')">Install</button>
        {% endif %}

        {% if d.role == 'Gauge' %}
        <button class="btn-identify" disabled style="opacity:.35;cursor:not-allowed;" title="Gauge devices are controlled by SimHub directly">Identify</button>
        <button class="btn-test" disabled style="opacity:.35;cursor:not-allowed;" title="Gauge devices are controlled by SimHub directly">Test</button>
        {% else %}
        <button class="btn-identify" title="Blink to identify (NumPad 9)" onclick="identify(this,'{{ d.key }}',{{ d.identify_id or 0 }})">Identify</button>
        <button class="btn-test" title="Test pattern (NumPad 0)" onclick="testDevice('{{ d.key }}',{{ d.identify_id or 0 }})">Test</button>
        {% endif %}

        <button class="btn-edit" onclick="openModal('{{ d.key }}','{{ d.name }}','{{ d.tags|join(', ') }}','{{ d.role }}',{{ d.channel or 0 }},'{{ d.group or '' }}','{{ d.simhub_uid or '' }}')">Edit</button>
      </div>
    </div>
  </div>
{% endfor %}
</div>

<div class="footer">
  <div>
    <span>Built by <strong>Matthew Wicks</strong></span> · 
    <span style="color:var(--accent)">JOML – Just One More Lap</span> · 
    <a href="https://www.youtube.com/@JOMLRacing" target="_blank">YouTube</a> · 
    <a href="https://github.com/meanstackofdoom/simhub-arduino-manager" target="_blank">GitHub</a>
    <span class="footer-btns" style="margin-left:12px;">
      <button class="footer-btn" onclick="openAbout()">About</button>
      <button class="footer-btn" onclick="openPlanned()">Roadmap</button>
      <button class="footer-btn" onclick="openChangelog()">Changelog</button>
    </span>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="tooltip">
      <button class="footer-btn" style="width:24px;height:24px;padding:0;border-radius:50%;" aria-label="Help">?</button>
      <div class="tooltip-bubble">NumPad 9 = Identify · NumPad 0 = Test · Auto-refresh 15s</div>
    </div>
    <button id="theme-toggle" class="footer-btn">Dark</button>
    <span style="font-size:10px;color:var(--muted);">v0.2.0 · {{ stats.last_scan }}</span>
  </div>
</div>

<div class="modal" id="about-modal">
  <div class="modal-box">
    <h2 style="color:var(--accent);margin:0 0 10px">About</h2>
    <p style="font-size:12px;color:var(--muted);line-height:1.4">
      This Arduino Port Manager keeps a stable JSON registry of your SimHub Arduinos
      (name, role, channel, group, and identify ID), and drives a custom SimHub plugin
      to blink or test each device on demand.
    </p>
    <p style="font-size:12px;color:var(--muted);line-height:1.4">
      Built with Python, Flask, pyserial, and a SimHub C# plugin so you can manage
      multiple rigs and Arduinos without fighting COM ports.
    </p>
    <p style="font-size:12px;color:var(--muted);line-height:1.4;margin-top:8px;">
      <strong>Basic guardrails:</strong> the header shows whether SimHub is running and if the Arduino Identify plugin DLL is found.
      Identify / Test will also report a clear error if either of those is missing.
    </p>
    <p style="font-size:12px;color:var(--muted);line-height:1.4;margin-top:4px;">
      NumPad 9 / NumPad 0 hotkey bindings still can't be auto-detected, so if they aren't mapped to the plugin actions
      Identify / Test may do nothing even though the header badges look OK.
    </p>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;">
      <button type="button"
              onclick="closeAbout()"
              style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;">
        Close
      </button>
    </div>
  </div>
</div>

<div class="modal" id="planned-modal">
  <div class="modal-box">
    <h2 style="color:var(--accent);margin:0 0 10px">Planned Features</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:6px;"><strong>0.2.x – Device Health &amp; Metadata</strong></p>
    <ul style="font-size:12px;color:var(--muted);padding-left:18px;margin-top:0;">
      <li>Live device health / heartbeat indicators</li>
      <li>RX / TX counters from SimHub (when API available)</li>
      <li>Firmware name &amp; MCU type display</li>
      <li>Baud rate &amp; LED count metadata</li>
      <li>Improved USB key normalization</li>
    </ul>
    <p style="font-size:12px;color:var(--muted);margin-bottom:6px;margin-top:10px;"><strong>0.3.x – Power User Features</strong></p>
    <ul style="font-size:12px;color:var(--muted);padding-left:18px;margin-top:0;">
      <li>Improved multi-profile management (per-rig presets, cloning, etc.)</li>
      <li>Export / import configurations beyond simple JSON snapshots</li>
      <li>Multi-rig support</li>
      <li>Improved SimHub API integration (if available)</li>
      <li>Optional background polling service</li>
    </ul>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;">
      <button type="button"
              onclick="closePlanned()"
              style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;">
        Close
      </button>
    </div>
  </div>
</div>

<div class="modal" id="changelog-modal">
  <div class="modal-box" style="max-height:70vh;overflow:auto;">
    <h2 style="color:var(--accent);margin:0 0 10px">Changelog</h2>
    <p style="font-size:12px;color:var(--muted);line-height:1.4;margin-bottom:6px;">
      Version <strong>0.1.0</strong> – Initial public release (2025-12-24).
    </p>
    <ul style="font-size:12px;color:var(--muted);padding-left:18px;margin-top:0;">
      <li>Initial SimHub Arduino Manager dashboard</li>
      <li>Automatic detection of connected Arduino serial ports</li>
      <li>Persistent device registry in <code>ports.json</code></li>
      <li>Per-device Identify ID, roles, tags, channels and groups</li>
      <li>Identify / Test actions wired through a custom SimHub plugin</li>
      <li>Profiles, hardware details, and connection duration per device</li>
    </ul>
    <p style="font-size:12px;color:var(--muted);margin-top:10px;">
      See <code>CHANGELOG.md</code> in the project root for the full history and planned roadmap.
    </p>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;">
      <button type="button"
              onclick="closeChangelog()"
              style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;">
        Close
      </button>
    </div>
  </div>
</div>

<div class="modal" id="modal">
<form class="modal-box" method="post" action="/update">
  <h2 style="color:var(--accent);margin:0 0 15px">
    Device Settings
  </h2>
  <input type="hidden" name="key" id="m-key">
  <input name="name" id="m-name" placeholder="Device name (e.g. Desk LEDs)">
  <div class="field-help">
    Friendly name shown as the card title (e.g. <em>Under Monitor</em>, <em>Wheel Base</em>).
  </div>
  <input name="tags" id="m-tags" placeholder="Tags (desk, dash, left)">
  <div class="field-help">
    Comma-separated labels used for filtering/search (e.g. <em>desk, dash, left</em>).
  </div>
  <select name="role" id="m-role">
    <option value="Unassigned">Unassigned</option>
    <option value="LED">LED</option>
    <option value="Gauge">Gauge</option>
    <option value="Buttons">Buttons</option>
    <option value="Other">Other</option>
  </select>
  <div class="field-help">
    How this Arduino is used in SimHub (LED strip, gauge, buttons, other).
  </div>
  <select name="channel" id="m-channel">
    <option value="0">Channel 0 – All</option>
    <option value="1">Channel 1 – Left</option>
    <option value="2">Channel 2 – Right</option>
    <option value="3">Channel 3 – Dash</option>
  </select>
  <div class="field-help">
    Logical zone your firmware uses. <strong>0</strong> = whole device, other channels = per-zone effects.
  </div>
  <input name="group" id="m-group" placeholder="Group (Desk, Wheel, Rig)">
  <div class="field-help">
    High-level rig location to help group devices (Desk, Wheel, Rig, Dash, etc.).
  </div>
  <select name="simhub_uid" id="m-simhub-uid">
    <option value="">— No SimHub Link —</option>
    {% for sh in simhub_devices %}
      <option value="{{ sh.uid }}">
        {{ sh.simhub_name or 'Unnamed' }} · {{ sh.rgb_leds }} LEDs · {{ sh.display_modules }} displays
      </option>
    {% endfor %}
  </select>
  <div class="field-help">
    Link to a SimHub device to pull metadata (LED count, modules, motors, etc.).
  </div>
  <div style="display:flex;gap:10px">
    <button type="button"
            style="background:#444;flex:1"
            onclick="closeModal()">
      Cancel
    </button>
    <button type="submit"
            style="background:var(--accent);flex:1">
      Save
    </button>
  </div>
</form>
</div>

<script>
const modal = document.getElementById("modal");
const aboutModal = document.getElementById("about-modal");
const plannedModal = document.getElementById("planned-modal");
const changelogModal = document.getElementById("changelog-modal");
const m_key = document.getElementById("m-key");
const m_name = document.getElementById("m-name");
const m_tags = document.getElementById("m-tags");
const m_role = document.getElementById("m-role");
const m_channel = document.getElementById("m-channel");
const m_group = document.getElementById("m-group");
const m_simhub_uid = document.getElementById("m-simhub-uid");
const themeToggle = document.getElementById("theme-toggle");

function installDevice(key){
  fetch(`/install/${key}`,{method:"POST"})
    .then(r=>r.ok?alert("Installed"):alert("Install failed"));
}

function identify(btn,key,id){
  if(!id){
    alert("No Identify ID assigned.\nInstall the device first.");
    return;
  }

  btn.classList.add("active");
  btn.disabled = true;
  btn.innerText = `Blinking ID ${id}…`;

  fetch(`/identify/${key}`, { method: "POST" })
    .then(r => {
      if (!r.ok) {
        return r.json().then(data => {
          alert(data.error || "Identify failed. Check SimHub and plugin status.");
        });
      }
    })
    .catch(() => {
      alert("Identify failed. Check SimHub and plugin status.");
    })
    .finally(() => {
      setTimeout(() => {
        btn.classList.remove("active");
        btn.disabled = false;
        btn.innerText = "Identify";
      }, 3500);
    });
}

function testDevice(key,id){
  if(!id){
    alert("No Identify ID assigned.\nInstall the device first.");
    return;
  }

  fetch(`/test/${key}`, { method: "POST" })
    .then(r => {
      if (!r.ok) {
        return r.json().then(data => {
          alert(data.error || "Test pattern failed. Check SimHub and plugin status.");
        });
      }
    })
    .catch(() => {
      alert("Test pattern failed. Check SimHub and plugin status.");
    });
}

function openModal(k,n,t,r,ch,g,shuid){
  modal.classList.add("open");
  m_key.value = k;
  m_name.value = n || "";
  m_tags.value = t || "";
  m_role.value = r || "Unassigned";
  m_channel.value = (ch || 0);
  m_group.value = g || "";
  m_simhub_uid.value = shuid || "";
}
function closeModal(){
  modal.classList.remove("open");
}
function filterCards(v){
  v=v.toLowerCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display=
      c.dataset.search.toLowerCase().includes(v)?"":"none";
  });
}
setInterval(()=>{
  if(!modal.classList.contains("open"))
    location.reload();
},15000);

function bulkInstall() {
    if (!confirm("This will assign IDs to all uninstalled devices. Continue?")) return;
    
    fetch('/bulk_install', { method: "POST" })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            location.reload();
        });
}

function openAbout(){
  if(aboutModal){
    aboutModal.classList.add("open");
  }
}
function closeAbout(){
  if(aboutModal){
    aboutModal.classList.remove("open");
  }
}

function openPlanned(){
  if(plannedModal){
    plannedModal.classList.add("open");
  }
}
function closePlanned(){
  if(plannedModal){
    plannedModal.classList.remove("open");
  }
}

function openChangelog(){
  if(changelogModal){
    changelogModal.classList.add("open");
  }
}
function closeChangelog(){
  if(changelogModal){
    changelogModal.classList.remove("open");
  }
}

function applyTheme(theme){
  document.body.setAttribute("data-theme", theme);
  if(themeToggle){
    themeToggle.textContent = theme === "light" ? "Light" : "Dark";
  }
  try{
    localStorage.setItem("theme", theme);
  }catch(e){}
}

(function initTheme(){
  let theme = "dark";
  try{
    theme = localStorage.getItem("theme") || "dark";
  }catch(e){}
  applyTheme(theme);

  if(themeToggle){
    themeToggle.onclick = function(){
      const current = document.body.getAttribute("data-theme") || "dark";
      const next = current === "light" ? "dark" : "light";
      applyTheme(next);
    };
  }
})();
</script>

</body>
</html>
