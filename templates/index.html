<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Arduino Port Manager</title>
<style>
:root{
  --bg:#0a0a0a;
  --panel:#111;
  --panel-hover:#161616;
  --border:#222;
  --text:#eee;
  --muted:#666;
  --accent:#10b981;
  --accent-dim:rgba(16,185,129,0.12);
  --danger:#ef4444;
  --danger-dim:rgba(239,68,68,0.12);
  --info:#3b82f6;
  --info-dim:rgba(59,130,246,0.12);
  --warning:#f59e0b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  font-size:13px;line-height:1.5;
  min-height:100vh;
}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:16px 20px;}

/* Header */
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;margin-bottom:16px;
  border-bottom:1px solid var(--border);
}
.logo{font-size:16px;font-weight:600;color:var(--accent);}
.logo span{color:var(--muted);font-weight:400;font-size:12px;margin-left:8px;}
.status-bar{display:flex;gap:8px;align-items:center;}
.status{
  display:flex;align-items:center;gap:4px;
  padding:4px 10px;border-radius:4px;font-size:11px;font-weight:500;
  background:var(--panel);border:1px solid var(--border);
}
.status.ok{color:var(--accent);border-color:var(--accent);background:var(--accent-dim);}
.status.bad{color:var(--danger);border-color:var(--danger);background:var(--danger-dim);}
.status::before{content:"";width:6px;height:6px;border-radius:50%;background:currentColor;}

/* Two column layout */
.main-grid{display:grid;grid-template-columns:1fr 320px;gap:20px;}
@media(max-width:1000px){.main-grid{grid-template-columns:1fr;}}

/* Device Grid */
.devices{display:flex;flex-direction:column;gap:8px;}
.section-title{
  font-size:11px;font-weight:600;text-transform:uppercase;
  letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;
  display:flex;align-items:center;gap:8px;
}
.section-title .count{
  background:var(--panel);padding:2px 8px;border-radius:10px;
  font-size:10px;color:var(--text);
}

/* Device Row */
.device{
  display:grid;grid-template-columns:1fr auto;
  background:var(--panel);border:1px solid var(--border);border-radius:6px;
  padding:12px 14px;gap:12px;
  transition:border-color .15s;
}
.device:hover{border-color:#333;}
.device-main{display:flex;flex-direction:column;gap:4px;min-width:0;}
.device-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.device-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.tag{
  font-size:10px;padding:2px 6px;border-radius:3px;font-weight:500;
  background:var(--panel-hover);color:var(--muted);
}
.tag.port{color:var(--info);background:var(--info-dim);font-family:monospace;}
.tag.id{color:var(--accent);background:var(--accent-dim);}
.tag.role{color:var(--warning);}
.device-hw{font-size:11px;color:var(--muted);margin-top:2px;}
.device-actions{display:flex;gap:6px;align-items:center;}

/* Buttons */
button{
  border:none;padding:6px 12px;border-radius:4px;
  font-size:11px;font-weight:500;cursor:pointer;
  transition:all .15s;background:var(--panel-hover);color:var(--text);
  border:1px solid var(--border);
}
button:hover{background:#222;border-color:#333;}
button.primary{background:var(--accent);color:#000;border-color:var(--accent);}
button.primary:hover{filter:brightness(1.1);}
button.small{padding:4px 8px;font-size:10px;}

/* Sidebar */
.sidebar{display:flex;flex-direction:column;gap:16px;}

/* History Panel */
.panel{
  background:var(--panel);border:1px solid var(--border);border-radius:6px;
  overflow:hidden;
}
.panel-header{
  padding:10px 12px;border-bottom:1px solid var(--border);
  font-size:11px;font-weight:600;text-transform:uppercase;
  letter-spacing:0.5px;color:var(--muted);
  display:flex;justify-content:space-between;align-items:center;
}
.panel-body{padding:8px 0;max-height:400px;overflow-y:auto;}

/* History Item */
.history-item{
  display:flex;gap:10px;padding:8px 12px;
  border-bottom:1px solid var(--border);font-size:12px;
}
.history-item:last-child{border-bottom:none;}
.history-icon{
  width:24px;height:24px;border-radius:4px;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;flex-shrink:0;
}
.history-icon.connected{background:var(--accent-dim);color:var(--accent);}
.history-icon.disconnected{background:var(--danger-dim);color:var(--danger);}
.history-content{flex:1;min-width:0;}
.history-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.history-detail{font-size:11px;color:var(--muted);}
.history-time{font-size:10px;color:var(--muted);white-space:nowrap;}

/* Custom Serial */
.serial-item{
  padding:10px 12px;border-bottom:1px solid var(--border);
}
.serial-item:last-child{border-bottom:none;}
.serial-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.serial-name{font-weight:500;font-size:12px;}
.serial-status{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600;text-transform:uppercase;}
.serial-status.on{background:var(--accent-dim);color:var(--accent);}
.serial-status.off{background:var(--danger-dim);color:var(--danger);}
.serial-status.disabled{background:var(--panel-hover);color:var(--muted);}
.serial-info{font-size:11px;color:var(--muted);}

/* Quick Stats */
.quick-stats{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
  padding:12px;
}
.stat{text-align:center;}
.stat-value{font-size:20px;font-weight:700;color:var(--accent);}
.stat-label{font-size:9px;color:var(--muted);text-transform:uppercase;}

/* Toolbar */
.toolbar{
  display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;
  padding:10px 12px;background:var(--panel);border:1px solid var(--border);border-radius:6px;
}
.toolbar input,.toolbar select{
  background:var(--bg);color:var(--text);border:1px solid var(--border);
  border-radius:4px;padding:6px 10px;font-size:12px;
}
.toolbar input:focus,.toolbar select:focus{outline:none;border-color:var(--accent);}
.toolbar-spacer{flex:1;}

/* Modal */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.8);
  display:none;align-items:center;justify-content:center;z-index:100;
}
.modal.open{display:flex;}
.modal-box{
  background:var(--panel);border:1px solid var(--border);border-radius:8px;
  padding:20px;width:360px;max-height:80vh;overflow-y:auto;
}
.modal-box h3{font-size:14px;font-weight:600;margin-bottom:16px;color:var(--accent);}
.modal-box input,.modal-box select,.modal-box textarea{
  width:100%;margin-bottom:12px;padding:10px;border-radius:4px;
  background:var(--bg);color:var(--text);border:1px solid var(--border);
  font-size:13px;font-family:inherit;
}
.modal-box textarea{resize:vertical;min-height:60px;}
.modal-box label{font-size:11px;color:var(--muted);display:block;margin-bottom:4px;}
.modal-actions{display:flex;gap:8px;margin-top:16px;}
.modal-actions button{flex:1;}

/* Empty state */
.empty{padding:40px 20px;text-align:center;color:var(--muted);}

/* Footer */
footer{
  margin-top:24px;padding:16px 0;border-top:1px solid var(--border);
  font-size:11px;color:var(--muted);
  display:flex;justify-content:space-between;
}
footer a{color:var(--accent);text-decoration:none;}
</style>
</head>
<body>

<div class="container">

<header>
  <div class="logo">
    Arduino Port Manager
    <span>v0.3.0</span>
  </div>
  <div class="status-bar">
    <div class="status {{ 'ok' if stats.connected > 0 else 'bad' }}">{{ stats.connected }} Online</div>
    <div class="status {{ 'ok' if stats.simhub_running else 'bad' }}">{{ 'SimHub' if stats.simhub_running else 'No SimHub' }}</div>
    <div class="status {{ 'ok' if stats.plugin_installed else 'bad' }}">{{ 'Plugin' if stats.plugin_installed else 'No Plugin' }}</div>
  </div>
</header>

<div class="toolbar">
  <input type="text" placeholder="Filter devices..." oninput="filterDevices(this.value)" style="width:200px;">
  <div class="toolbar-spacer"></div>
  <select onchange="if(this.value)loadProfile(this.value)" style="width:140px;">
    <option value="">Load Profile...</option>
    {% for p in profiles %}
    <option value="{{ p }}">{{ p }}</option>
    {% endfor %}
  </select>
  <input type="text" id="profile-name" placeholder="Profile name" style="width:120px;">
  <button onclick="saveProfile()">Save</button>
  <button class="primary" onclick="bulkInstall()">Bulk Install</button>
</div>

<div class="main-grid">

<!-- Left: Devices -->
<div class="devices-column">
  
  <div class="section-title">
    Connected Devices
    <span class="count">{{ devices|length }}</span>
  </div>
  
  <div class="devices">
    {% if devices %}
    {% for d in devices %}
    <div class="device" data-search="{{ d.name|lower }} {{ d.port|lower }} {{ d.role|lower }}">
      <div class="device-main">
        <div class="device-name">{{ d.name or 'New Device' }}</div>
        <div class="device-meta">
          <span class="tag port">{{ d.port }}</span>
          {% if d.identify_id %}<span class="tag id">ID {{ d.identify_id }}</span>{% endif %}
          {% if d.role and d.role != 'Unassigned' %}<span class="tag role">{{ d.role }}</span>{% endif %}
          {% if d.group %}<span class="tag">{{ d.group }}</span>{% endif %}
        </div>
        <div class="device-hw">
          {{ d.description or 'USB Device' }}
          {% if d.vid and d.pid %} Â· {{ d.vid }}:{{ d.pid }}{% endif %}
          {% if d.connected_for %} Â· {{ d.connected_for }}{% endif %}
        </div>
      </div>
      <div class="device-actions">
        {% if not d.installed %}
        <button class="small" onclick="installDevice('{{ d.key }}')">Install</button>
        {% else %}
        <button class="small" onclick="identify('{{ d.key }}',{{ d.identify_id or 0 }})">Identify</button>
        {% endif %}
        <button class="small primary" onclick="editDevice('{{ d.key }}','{{ d.name|e }}','{{ d.role }}',{{ d.channel or 0 }},'{{ d.group or '' }}','{{ d.simhub_uid or '' }}','{{ d.notes|default('',true)|e }}')">Edit</button>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty">No devices connected</div>
    {% endif %}
  </div>

</div>

<!-- Right: Sidebar -->
<div class="sidebar">

  <!-- Quick Stats -->
  <div class="panel">
    <div class="quick-stats">
      <div class="stat">
        <div class="stat-value">{{ stats.connected }}</div>
        <div class="stat-label">Online</div>
      </div>
      <div class="stat">
        <div class="stat-value">{{ stats.identify_count }}</div>
        <div class="stat-label">Identifies</div>
      </div>
      <div class="stat">
        <div class="stat-value">{{ stats.uptime }}</div>
        <div class="stat-label">Uptime</div>
      </div>
    </div>
  </div>

  <!-- Device History -->
  <div class="panel">
    <div class="panel-header">
      <span>ðŸ“‹ Device History</span>
      <span style="font-weight:400;text-transform:none;">{{ device_history|length }} events</span>
    </div>
    <div class="panel-body">
      {% if device_history %}
      {% for event in device_history %}
      <div class="history-item">
        <div class="history-icon {{ event.type }}">
          {{ 'â†‘' if event.type == 'connected' else 'â†“' }}
        </div>
        <div class="history-content">
          <div class="history-name">{{ event.name }}</div>
          <div class="history-detail">{{ event.port }} Â· {{ event.type }}</div>
        </div>
        <div class="history-time">{{ event.time[11:16] }}</div>
      </div>
      {% endfor %}
      {% else %}
      <div class="empty" style="padding:20px;">No history yet</div>
      {% endif %}
    </div>
  </div>

  <!-- Custom Serial -->
  {% if custom_serial_devices %}
  <div class="panel">
    <div class="panel-header">
      <span>âš¡ Custom Serial</span>
      <span style="font-weight:400;text-transform:none;">{{ custom_serial_devices|length }}</span>
    </div>
    <div class="panel-body" style="padding:0;">
      {% for cs in custom_serial_devices %}
      <div class="serial-item">
        <div class="serial-header">
          <span class="serial-name">{{ cs.name }}</span>
          {% if not cs.is_enabled %}
          <span class="serial-status disabled">Disabled</span>
          {% elif cs.is_connected %}
          <span class="serial-status on">Connected</span>
          {% else %}
          <span class="serial-status off">Offline</span>
          {% endif %}
        </div>
        <div class="serial-info">
          {{ cs.port or 'No port' }} Â· {{ cs.baud_rate }} baud
          {% if cs.expression_type %} Â· {{ cs.expression_type }}{% endif %}
        </div>
        {% if cs.custom_description %}
        <div style="font-size:11px;color:var(--text);margin-top:4px;">{{ cs.custom_description }}</div>
        {% endif %}
        <button class="small" style="margin-top:6px;" onclick="editCustomSerial('{{ cs.notes_key|e }}','{{ cs.custom_description|default('',true)|e }}','{{ cs.notes|default('',true)|e }}')">Edit Notes</button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>

</div>

<footer>
  <div>
    Built by <strong>Matthew Wicks</strong> Â· 
    <a href="https://github.com/meanstackofdoom/simhub-arduino-manager" target="_blank">GitHub</a>
  </div>
  <div>{{ stats.last_scan }}</div>
</footer>

</div>

<!-- Edit Device Modal -->
<div class="modal" id="edit-modal">
  <form class="modal-box" method="post" action="/update">
    <h3>Edit Device</h3>
    <input type="hidden" name="key" id="edit-key">
    <label>Name</label>
    <input name="name" id="edit-name" placeholder="Device name">
    <label>Role</label>
    <select name="role" id="edit-role">
      <option value="Unassigned">Unassigned</option>
      <option value="LED">LED</option>
      <option value="Gauge">Gauge</option>
      <option value="Buttons">Buttons</option>
      <option value="Other">Other</option>
    </select>
    <label>Channel</label>
    <select name="channel" id="edit-channel">
      <option value="0">0 - All</option>
      <option value="1">1 - Left</option>
      <option value="2">2 - Right</option>
      <option value="3">3 - Dash</option>
    </select>
    <label>Group</label>
    <input name="group" id="edit-group" placeholder="Desk, Wheel, Rig...">
    <label>SimHub Link</label>
    <select name="simhub_uid" id="edit-simhub">
      <option value="">â€” None â€”</option>
      {% for sh in simhub_devices %}
      <option value="{{ sh.uid }}">{{ sh.simhub_name or 'Device' }} ({{ sh.rgb_leds }} LEDs)</option>
      {% endfor %}
    </select>
    <label>Notes</label>
    <textarea name="notes" id="edit-notes" placeholder="Wiring info, pins..."></textarea>
    <div class="modal-actions">
      <button type="button" onclick="closeModal('edit-modal')">Cancel</button>
      <button type="submit" class="primary">Save</button>
    </div>
  </form>
</div>

<!-- Custom Serial Modal -->
<div class="modal" id="cs-modal">
  <form class="modal-box" method="post" action="/update_custom_serial">
    <h3>Custom Serial Notes</h3>
    <input type="hidden" name="port" id="cs-port">
    <label>Description</label>
    <input name="description" id="cs-desc" placeholder="e.g. Boost Gauge">
    <label>Notes</label>
    <textarea name="notes" id="cs-notes" placeholder="Calibration, wiring..."></textarea>
    <div class="modal-actions">
      <button type="button" onclick="closeModal('cs-modal')">Cancel</button>
      <button type="submit" class="primary">Save</button>
    </div>
  </form>
</div>

<script>
function filterDevices(q) {
  q = q.toLowerCase();
  document.querySelectorAll('.device').forEach(d => {
    d.style.display = d.dataset.search.includes(q) ? '' : 'none';
  });
}

function installDevice(key) {
  fetch('/install/' + encodeURIComponent(key), {method: 'POST'})
    .then(r => r.ok ? location.reload() : alert('Install failed'));
}

function identify(key, id) {
  if (!id) { alert('Install device first'); return; }
  fetch('/identify/' + encodeURIComponent(key), {method: 'POST'})
    .then(r => { if (!r.ok) r.json().then(d => alert(d.error)); });
}

function editDevice(key, name, role, channel, group, simhub, notes) {
  document.getElementById('edit-key').value = key;
  document.getElementById('edit-name').value = name || '';
  document.getElementById('edit-role').value = role || 'Unassigned';
  document.getElementById('edit-channel').value = channel || 0;
  document.getElementById('edit-group').value = group || '';
  document.getElementById('edit-simhub').value = simhub || '';
  document.getElementById('edit-notes').value = notes || '';
  document.getElementById('edit-modal').classList.add('open');
}

function editCustomSerial(port, desc, notes) {
  document.getElementById('cs-port').value = port || '';
  document.getElementById('cs-desc').value = desc || '';
  document.getElementById('cs-notes').value = notes || '';
  document.getElementById('cs-modal').classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function saveProfile() {
  const name = document.getElementById('profile-name').value.trim();
  if (!name) { alert('Enter a profile name'); return; }
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/profile/save';
  const input = document.createElement('input');
  input.name = 'name';
  input.value = name;
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

function loadProfile(name) {
  if (!name) return;
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/profile/load';
  const input = document.createElement('input');
  input.name = 'name';
  input.value = name;
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

function bulkInstall() {
  if (!confirm('Install all uninstalled devices?')) return;
  fetch('/bulk_install', {method: 'POST'})
    .then(r => r.json())
    .then(d => { alert(d.message); location.reload(); });
}

// Auto-refresh every 15s if no modal open
setInterval(() => {
  if (!document.querySelector('.modal.open')) location.reload();
}, 15000);

// Close modal on escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));
  }
});
</script>

</body>
</html>
