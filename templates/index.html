<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Arduino Port History Manager</title>

<style>
:root{
  --panel:#0d0d0d;--panel-alt:#141414;--panel-elevated:#1a1a1a;
  --border:#252525;--border-subtle:#1f1f1f;
  --text:#f0f0f0;--text-secondary:#b0b0b0;--muted:#707070;
  --accent:#22c55e;--accent-dim:rgba(34,197,94,0.15);
  --danger:#ef4444;--danger-dim:rgba(239,68,68,0.15);
  --info:#3b82f6;--info-dim:rgba(59,130,246,0.15);
  --warning:#f59e0b;--warning-dim:rgba(245,158,11,0.15);
}

body[data-theme="light"]{
  --panel:#f8f9fa;--panel-alt:#ffffff;--panel-elevated:#ffffff;
  --border:#e5e7eb;--border-subtle:#f0f0f0;
  --text:#111827;--text-secondary:#4b5563;--muted:#9ca3af;
  --accent:#059669;--accent-dim:rgba(5,150,105,0.1);
  --danger:#dc2626;--danger-dim:rgba(220,38,38,0.1);
  --info:#2563eb;--info-dim:rgba(37,99,235,0.1);
  --warning:#d97706;--warning-dim:rgba(217,119,6,0.1);
  background:linear-gradient(135deg,#f5f7fa 0%,#e4e8ed 100%);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  padding:20px 24px;
  background:#080808;
  color:var(--text);
  font-family:"Inter",-apple-system,"Segoe UI",sans-serif;
  display:flex;flex-direction:column;min-height:100vh;
  line-height:1.5;
}

/* Header */
header{
  display:flex;justify-content:space-between;align-items:flex-start;
  margin-bottom:20px;gap:16px;flex-wrap:wrap;
}
.header-left h1{
  font-size:22px;font-weight:700;color:var(--accent);
  letter-spacing:-0.5px;margin-bottom:2px;
}
.header-left .subtitle{font-size:12px;color:var(--muted);}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

/* Status pills */
.pill{
  padding:4px 10px;border-radius:12px;font-size:11px;
  font-weight:600;text-transform:uppercase;letter-spacing:0.5px;
  border:1px solid var(--border);
}
.pill.connected{background:var(--accent-dim);color:var(--accent);border-color:var(--accent);}
.pill.total{background:var(--info-dim);color:var(--info);border-color:var(--info);}
.pill.uptime{background:var(--panel-alt);color:var(--text-secondary);}

/* Theme toggle */
.theme-toggle{
  background:var(--panel-alt);border:1px solid var(--border);
  border-radius:8px;padding:6px;cursor:pointer;color:var(--text);
  font-size:18px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;
}
.theme-toggle:hover{background:var(--panel-elevated);}

/* Main layout */
.main{
  display:grid;grid-template-columns:1fr 380px;gap:20px;
  margin-bottom:20px;
}
@media (max-width: 1024px){
  .main{grid-template-columns:1fr;}
}

/* Device cards */
.devices{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:16px;
}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;
  padding:16px;transition:all 0.2s ease;position:relative;
}
.card:hover{
  border-color:var(--accent);transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(0,0,0,0.3);
}
.card-header{
  display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;
}
.card-title{
  font-weight:600;font-size:14px;color:var(--text);
  margin-bottom:2px;word-break:break-word;
}
.card-subtitle{
  font-size:11px;color:var(--muted);font-family:monospace;
}
.card-status{
  width:8px;height:8px;background:var(--accent);border-radius:50%;
  margin-top:2px;
}
.card-body{
  font-size:12px;color:var(--text-secondary);line-height:1.4;
}
.card-footer{
  margin-top:12px;padding-top:12px;border-top:1px solid var(--border-subtle);
  display:flex;justify-content:space-between;align-items:center;
  font-size:11px;color:var(--muted);
}
.card-actions{
  display:flex;gap:6px;margin-top:12px;
}
.btn{
  padding:6px 12px;border-radius:6px;font-size:11px;font-weight:500;
  border:1px solid var(--border);background:var(--panel-alt);
  color:var(--text);cursor:pointer;transition:all 0.2s ease;
  text-decoration:none;display:inline-flex;align-items:center;gap:4px;
}
.btn:hover{
  background:var(--panel-elevated);border-color:var(--accent);
  transform:translateY(-1px);
}
.btn.primary{
  background:var(--accent);color:white;border-color:var(--accent);
}
.btn.primary:hover{
  background:#16a34a;border-color:#16a34a;
}

/* Sidebar */
.sidebar{
  display:flex;flex-direction:column;gap:20px;
}
.panel{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;
  padding:16px;
}
.panel-title{
  font-weight:600;font-size:13px;color:var(--text);
  margin-bottom:12px;display:flex;align-items:center;gap:6px;
}
.panel-content{
  font-size:12px;color:var(--text-secondary);
}
.stat-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:4px 0;border-bottom:1px solid var(--border-subtle);
}
.stat-row:last-child{border-bottom:none;}
.stat-label{color:var(--muted);}
.stat-value{font-weight:600;color:var(--text);}

/* Timeline */
.timeline{
  max-height:300px;overflow-y:auto;
}
.timeline-item{
  display:flex;gap:8px;padding:8px 0;border-bottom:1px solid var(--border-subtle);
  font-size:11px;
}
.timeline-item:last-child{border-bottom:none;}
.timeline-time{
  color:var(--muted);font-family:monospace;min-width:60px;
}
.timeline-content{
  flex:1;
}
.timeline-event{
  font-weight:500;color:var(--text);
}
.timeline-details{
  color:var(--text-secondary);margin-top:2px;
}
.event-connected{color:var(--accent);}
.event-disconnected{color:var(--danger);}
.event-port_change{color:var(--warning);}

/* Analytics */
.analytics-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
}
.analytics-item{
  background:var(--panel-alt);padding:8px;border-radius:6px;
  text-align:center;
}
.analytics-value{
  font-size:16px;font-weight:700;color:var(--accent);
}
.analytics-label{
  font-size:10px;color:var(--muted);text-transform:uppercase;
  letter-spacing:0.5px;margin-top:2px;
}

/* Forms */
.form-group{
  margin-bottom:12px;
}
.form-label{
  display:block;font-size:11px;font-weight:500;color:var(--text);
  margin-bottom:4px;
}
.form-input{
  width:100%;padding:8px 10px;border:1px solid var(--border);
  border-radius:6px;background:var(--panel-alt);color:var(--text);
  font-size:12px;font-family:inherit;
}
.form-input:focus{
  outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-dim);
}
.form-select{
  width:100%;padding:8px 10px;border:1px solid var(--border);
  border-radius:6px;background:var(--panel-alt);color:var(--text);
  font-size:12px;font-family:inherit;
}
.modal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;
}
.modal.active{display:flex;}
.modal-content{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;
  padding:20px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;
}
.modal-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:16px;
}
.modal-title{
  font-size:16px;font-weight:600;color:var(--text);
}
.modal-close{
  background:none;border:none;color:var(--muted);font-size:20px;
  cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;
}
.modal-close:hover{color:var(--text);}
.modal-footer{
  display:flex;gap:8px;justify-content:flex-end;margin-top:16px;
}

/* Loading */
.loading{
  text-align:center;padding:40px;color:var(--muted);
}
.loading::after{
  content:"";display:inline-block;width:20px;height:20px;
  border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* Scrollbar */
::-webkit-scrollbar{width:8px;height:8px;}
::-webkit-scrollbar-track{background:var(--panel);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
</style>
</head>
<body data-theme="dark">

<header>
  <div class="header-left">
    <h1>üîå Port History Manager</h1>
    <div class="subtitle">Track Arduino connections and port usage over time</div>
  </div>
  <div class="header-right">
    <span class="pill connected">{{ stats.connected }} connected</span>
    <span class="pill total">{{ stats.total_ports }} ports</span>
    <span class="pill uptime">{{ stats.uptime }}</span>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  </div>
</header>

<div class="main">
  <section class="devices-section">
    <div class="devices">
      {% for device in devices %}
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">{{ device.name }}</div>
            <div class="card-subtitle">{{ device.port }}</div>
          </div>
          <div class="card-status"></div>
        </div>
        <div class="card-body">
          <div><strong>VID:PID:</strong> {{ device.vid_hex or "N/A" }}:{{ device.pid_hex or "N/A" }}</div>
          <div><strong>Connected for:</strong> {{ device.connected_for }}</div>
          <div><strong>Role:</strong> {{ device.role }}</div>
          {% if device.group %}
          <div><strong>Group:</strong> {{ device.group }}</div>
          {% endif %}
          {% if device.notes %}
          <div><strong>üìù Notes:</strong> {{ device.notes }}</div>
          {% endif %}
        </div>
        <div class="card-footer">
          <span>{{ device.manufacturer or "Unknown" }}</span>
          <span>{{ device.connected_for }}</span>
        </div>
        <div class="card-actions">
          {% if not device.installed %}
          <form method="POST" action="/install/{{ device.key }}" style="display:inline;">
            <button type="submit" class="btn primary">Install</button>
          </form>
          {% endif %}
          <button class="btn" onclick="editDevice('{{ device.key }}')">Edit</button>
          <button class="btn" onclick="viewHistory('{{ device.key }}')">History</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <aside class="sidebar">
    <!-- Analytics Panel -->
    <div class="panel">
      <div class="panel-title">üìä Analytics</div>
      <div class="panel-content">
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-value">{{ analytics.total_ports }}</div>
            <div class="analytics-label">Total Ports</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-value">{{ analytics.active_ports }}</div>
            <div class="analytics-label">Active</div>
          </div>
        </div>
        {% if analytics.most_used_ports %}
        <div style="margin-top:12px;">
          <div style="font-weight:500;margin-bottom:4px;">Most Used Ports:</div>
          {% for port, count in analytics.most_used_ports[:3] %}
          <div class="stat-row">
            <span class="stat-label">{{ port }}</span>
            <span class="stat-value">{{ count }}√ó</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Timeline Panel -->
    <div class="panel">
      <div class="panel-title">üìÖ Recent Activity</div>
      <div class="panel-content">
        <div class="timeline">
          {% for event in timeline %}
          <div class="timeline-item">
            <div class="timeline-time">{{ event.time.split('T')[1].split('.')[0][:5] }}</div>
            <div class="timeline-content">
              <div class="timeline-event event-{{ event.type }}">
                {% if event.type == 'connected' %}üîå Connected
                {% elif event.type == 'disconnected' %}üîå Disconnected
                {% elif event.type == 'port_change' %}üîÑ Port Change
                {% endif %}
              </div>
              <div class="timeline-details">{{ event.device_name }} on {{ event.port }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Actions Panel -->
    <div class="panel">
      <div class="panel-title">‚ö° Actions</div>
      <div class="panel-content">
        <form method="POST" action="/bulk_install" style="margin-bottom:8px;">
          <button type="submit" class="btn primary" style="width:100%;">Install All Devices</button>
        </form>
        <button class="btn" onclick="refreshPage()" style="width:100%;">üîÑ Refresh</button>
        <button class="btn" onclick="exportHistory()" style="width:100%;">üì• Export History</button>
      </div>
    </div>
  </aside>
</div>

<!-- Edit Device Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Edit Device</div>
      <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
    </div>
    <form method="POST" action="/update">
      <input type="hidden" id="editKey" name="key">
      
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" name="name" id="editName" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label">Role</label>
        <select name="role" id="editRole" class="form-select">
          <option value="Unassigned">Unassigned</option>
          <option value="LED">LED</option>
          <option value="Gauge">Gauge</option>
          <option value="Buttons">Buttons</option>
          <option value="Display">Display</option>
          <option value="Other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Tags (comma separated)</label>
        <input type="text" name="tags" id="editTags" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label">Group</label>
        <input type="text" name="group" id="editGroup" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label">Channel</label>
        <input type="number" name="channel" id="editChannel" class="form-input" min="0" value="0">
      </div>
      
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea name="notes" id="editNotes" class="form-input" rows="3"></textarea>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal('editModal')">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
// Theme toggle
function toggleTheme(){
  const body = document.body;
  const btn = document.querySelector('.theme-toggle');
  const isDark = body.dataset.theme === 'dark';
  
  body.dataset.theme = isDark ? 'light' : 'dark';
  btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', body.dataset.theme);
}

// Load saved theme
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.dataset.theme = savedTheme;
document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

// Device data for editing
const deviceData = {{ devices | tojson }};

function editDevice(key){
  const device = deviceData.find(d => d.key === key);
  if (!device) return;
  
  document.getElementById('editKey').value = device.key;
  document.getElementById('editName').value = device.name || '';
  document.getElementById('editRole').value = device.role || 'Unassigned';
  document.getElementById('editTags').value = (device.tags || []).join(', ');
  document.getElementById('editGroup').value = device.group || '';
  document.getElementById('editChannel').value = device.channel || 0;
  document.getElementById('editNotes').value = device.notes || '';
  
  document.getElementById('editModal').classList.add('active');
}

function closeModal(modalId){
  document.getElementById(modalId).classList.remove('active');
}

function refreshPage(){
  window.location.reload();
}

function exportHistory(){
  fetch('/api/export_history')
    .then(response => response.json())
    .then(data => {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `port_history_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    })
    .catch(error => console.error('Export failed:', error));
}

function viewHistory(key){
  fetch(`/api/device_history/${key}`)
    .then(response => response.json())
    .then(data => {
      alert(`Device History:\n\n${data.map(e => 
        `${e.time.split('T')[0]} ${e.time.split('T')[1].split('.')[0]} - ${e.type.toUpperCase()}: ${e.port}`
      ).join('\n')}`);
    })
    .catch(error => console.error('History fetch failed:', error));
}

// Auto-refresh every 30 seconds
setTimeout(() => {
  window.location.reload();
}, 30000);
</script>

</body>
</html>
